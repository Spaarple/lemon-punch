---
export interface Props {
    address: string;
}
const { address } = Astro.props;

let coordinates: [number, number] | null = null;
let errorMessage: string | null = null;

if (address && address.trim() !== '') {
    const urlApiNominatim = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURI(address)}`;

    try {
        const response = await fetch(urlApiNominatim, {
            headers: {'User-Agent': 'LemonPunch - contact@spaarple.fr'}
        });
        const data = await response.json();

        if (data && data.length > 0) {
            coordinates = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
        } else {
            errorMessage = "Désolé, l'adresse n'a pas pu être trouvée.";
        }
    } catch (error) {
        console.error('Erreur lors de la géolocalisation:', error);
        errorMessage = "Erreur lors de la recherche de l'adresse.";
    }
} else {
    errorMessage = "Aucune adresse n'a été spécifiée.";
}

// Générer un ID unique pour chaque carte
const mapId = `map-${Math.random().toString(36).substr(2, 9)}`;
---

{coordinates ? (
    <div>
        <div id={mapId} style="height: 400px; width: 100%;"></div>

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
              integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
              crossorigin=""/>

        <script is:inline define:vars={{ mapId, coordinates, address }}>
            // Charger Leaflet dynamiquement
            if (typeof window !== 'undefined' && !window.leafletLoaded) {
                window.leafletLoaded = true;
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
                script.crossOrigin = '';
                script.onload = function() {
                    initMap();
                };
                document.head.appendChild(script);
            } else if (typeof window !== 'undefined' && window.L) {
                // Leaflet déjà chargé
                initMap();
            } else if (typeof window !== 'undefined') {
                // Attendre que Leaflet soit chargé
                setTimeout(() => {
                    if (window.L) initMap();
                }, 500);
            }

            function initMap() {
                if (typeof window === 'undefined' || !window.L) return;

                const mapElement = document.getElementById(mapId);
                if (!mapElement || mapElement.dataset.initialized) return;

                mapElement.dataset.initialized = 'true';

                const map = window.L.map(mapId).setView(coordinates, 15);

                window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 20
                }).addTo(map);

                const marker = window.L.marker(coordinates).addTo(map);
                marker.bindPopup(`<b>${address}</b>`).openPopup();
            }
        </script>
    </div>
) : (
    <p style="text-align: center; padding: 2rem; color: var(--gray);">{errorMessage}</p>
)}