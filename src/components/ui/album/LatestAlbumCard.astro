---
import AlbumCover from './AlbumCover.astro';
import StreamingLinks from './StreamingLinks.astro';

export interface Props {
    album: {
        title: { rendered: string };
        slug: string;
        date: string;
        content?: { rendered: string };
        acf: any;
        _embedded?: {
            'wp:featuredmedia'?: Array<{
                source_url: string;
            }>;
        };
        releaseType?: string;
    };
}

const { album } = Astro.props;

// Extraction des liens de streaming (limit√© aux principaux)
const maxLinks = 10;
const streamingLinks = Array.from({ length: maxLinks }, (_, i) => {
    const platform = album.acf[`plateforme_${i + 1}`];
    const url = album.acf[`url_${i + 1}`];
    if (platform && url) {
        return { platform, url };
    }
    return null;
}).filter(Boolean).slice(0, 3); // Limiter √† 3 liens pour la page d'accueil

const coverImage = album._embedded?.['wp:featuredmedia']?.[0];

// Utiliser release_date de ACF ou date WordPress comme fallback
function formatReleaseDate(album) {
    const releaseDate = album.acf?.release_date || album.date;

    if (releaseDate && releaseDate.length === 8) {
        // Format YYYYMMDD
        const year = releaseDate.substring(0, 4);
        const month = releaseDate.substring(4, 6);
        const day = releaseDate.substring(6, 8);
        return new Date(year, month - 1, day);
    } else if (releaseDate) {
        // Format date WordPress
        return new Date(releaseDate);
    }
    return null;
}

// Fonction pour formater la date en fran√ßais
function formatDateFrench(date) {
    if (!date) return null;

    const months = [
        'janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin',
        'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'
    ];

    const day = date.getDate();
    const month = months[date.getMonth()];
    const year = date.getFullYear();

    return `${day} / ${month} / ${year}`;
}

const releaseDate = formatReleaseDate(album);
const formattedDate = formatDateFrench(releaseDate);

// Extraire une description courte
function getShortDescription(content: string, maxLength: number = 150): string {
    if (!content) return '';
    const textOnly = content.replace(/<[^>]*>/g, ''); // Supprimer les balises HTML
    return textOnly.length > maxLength
        ? textOnly.substring(0, maxLength).trim() + '...'
        : textOnly;
}

const shortDescription = getShortDescription(album.content?.rendered || '');
---

<div class="latest-album-card">
    <div class="album-card-art">
        <AlbumCover
            image={coverImage}
            title={album.title.rendered}
            size="standard"
            href={`/albums/${album.slug}/`}
            releaseType={album.releaseType}
        />
    </div>

    <div class="album-card-info">
        <div class="album-meta">
            <span class="release-badge">
                {album.releaseType === 'Album' ? 'NOUVEL ALBUM' :
                 album.releaseType === 'Single' ? 'NOUVEAU SINGLE' :
                 `NOUVEAU ${album.releaseType.toUpperCase()}`}
            </span>
            <h3 class="album-title">{album.title.rendered}</h3>
            {formattedDate && (
                <p class="album-date">{formattedDate}</p>
            )}
        </div>

        {shortDescription && (
            <p class="album-description">{shortDescription}</p>
        )}

        {album.acf.extrait_de_lalbum?.url && (
            <div class="audio-preview">
                <h4>üéµ Extrait disponible</h4>
                <audio controls src={album.acf.extrait_de_lalbum.url} preload="metadata">
                    Votre navigateur ne supporte pas l'√©l√©ment audio.
                </audio>
            </div>
        )}

        <div class="album-actions">
            {streamingLinks.length > 0 && (
                <div class="streaming-section">
                    <StreamingLinks
                        links={streamingLinks}
                        variant="horizontal"
                        size="small"
                    />
                </div>
            )}

            <div class="album-link-section">
                <a href={`/albums/${album.slug}/`} class="btn-album-details">
                    <i class="fas fa-info-circle"></i>
                    Voir tous les d√©tails
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    .latest-album-card {
        display: flex;
        gap: 3rem;
        align-items: flex-start;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }

    .latest-album-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
    }

    .album-card-art {
        flex-shrink: 0;
    }

    .album-card-info {
        flex: 1;
    }

    .album-meta {
        margin-bottom: 1.5rem;
    }

    .release-badge {
        display: inline-block;
        background: linear-gradient(135deg, var(--primary-yellow), #f39c12);
        color: var(--black);
        padding: 8px 16px;
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-radius: 20px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(244, 208, 63, 0.3);
    }

    .album-title {
        font-size: 2.2rem;
        font-weight: 900;
        color: var(--black);
        margin: 0.5rem 0;
        line-height: 1.2;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .album-date {
        font-size: 1.1rem;
        color: var(--primary-yellow);
        font-weight: 600;
        margin: 0;
    }

    .album-description {
        font-size: 1.05rem;
        line-height: 1.6;
        color: var(--gray);
        margin-bottom: 1.5rem;
        font-style: italic;
    }

    .audio-preview {
        margin: 1.5rem 0;
        padding: 1rem;
        background: rgba(244, 208, 63, 0.1);
        border-radius: 8px;
        border-left: 4px solid var(--primary-yellow);
    }

    .audio-preview h4 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--black);
        margin-bottom: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .audio-preview audio {
        width: 100%;
        height: 35px;
        border-radius: 4px;
    }

    .album-actions {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .streaming-section {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
    }

    .album-link-section {
        padding-top: 1rem;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .btn-album-details {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--black);
        color: var(--white);
        padding: 12px 20px;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-radius: 6px;
        border: 2px solid var(--black);
    }

    .btn-album-details:hover {
        background: var(--primary-yellow);
        color: var(--black);
        border-color: var(--primary-yellow);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(244, 208, 63, 0.4);
    }

    .btn-album-details i {
        font-size: 0.9em;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .latest-album-card {
            flex-direction: column;
            gap: 2rem;
            text-align: center;
            padding: 1.5rem;
        }

        .album-title {
            font-size: 1.8rem;
        }

        .album-actions {
            gap: 1rem;
        }

        .streaming-section {
            justify-content: center;
        }
    }

    @media (max-width: 480px) {
        .latest-album-card {
            padding: 1rem;
            gap: 1.5rem;
        }

        .album-title {
            font-size: 1.6rem;
        }

        .album-description {
            font-size: 1rem;
        }

        .audio-preview {
            padding: 0.8rem;
        }

        .btn-album-details {
            padding: 10px 16px;
            font-size: 0.9rem;
            width: 100%;
            justify-content: center;
        }
    }
</style>